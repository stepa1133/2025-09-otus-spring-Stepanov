<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8"/>
    <title>Список комментариев</title>

    <style type="text/css">
        body {
            padding: 50px;
            font-family: Arial, sans-serif;
        }

        .comments {
            border: 1px solid steelblue;
            width: 500px;
            border-collapse: collapse;
        }

        .comments tr td,
        .comments th {
            padding: 5px;
            border: 1px solid steelblue;
        }

        .comments td:first-child,
        .comments td:last-child {
            width: 50px;
            text-align: center;
        }

        button {
            cursor: pointer;
        }

        .action-form {
            display: inline-block;
            margin-right: 5px;
        }
    </style>
</head>

<body>

<h3>Комментарии книги</h3>

<table class="comments">
    <thead>
    <tr>
        <th>ID</th>
        <th>Комментарий</th>
        <th>Действия</th>
    </tr>
    </thead>

    <tbody id="comments-body">
    <!-- JS рендер -->
    </tbody>

    <tfoot>
    <tr>
        <td colspan="2" style="text-align: center; font-style: italic;">
            Всего комментариев: <span id="comments-count">0</span>
        </td>
        <td>
            <!-- КНОПКА ДОБАВИТЬ -->
            <button type="button" onclick="goToAddComment()">Добавить</button>

            <!-- НА ГЛАВНУЮ -->
            <form action="/book" method="get" class="action-form">
                <button type="submit">На главную</button>
            </form>
        </td>
    </tr>
    </tfoot>
</table>

<script>
    const pathParts = window.location.pathname.split('/');
    const bookId = pathParts[2];

    const state = {
        comments: []
    };

    function setComments(comments) {
        state.comments = comments;
        render();
    }

    function render() {
        const tbody = document.getElementById("comments-body");
        const count = document.getElementById("comments-count");

        tbody.innerHTML = "";
        count.textContent = state.comments.length;

        state.comments.forEach(comment => {
            const tr = document.createElement("tr");

            tr.innerHTML = `
                <td>${comment.id}</td>
                <td>${comment.commentary}</td>
                <td>
                    <button type="button"
                            data-comment-id="${comment.id}"
                            onclick="deleteComment(this)">
                        Удалить
                    </button>
                </td>
            `;

            tbody.appendChild(tr);
        });
    }

    async function loadComments() {
        try {
            const response = await fetch(`/api/book/${bookId}/comment`);
            if (!response.ok) throw new Error("Ошибка загрузки комментариев");
            const data = await response.json();
            setComments(data);
        } catch (err) {
            alert("Ошибка загрузки комментариев");
            console.error(err);
        }
    }

    async function deleteComment(button) {
        const commentId = button.getAttribute('data-comment-id');
        const commentText = button.closest('tr').querySelector('td:nth-child(2)').innerText;

        if (!confirm(`Точно удалить комментарий "${commentText}"?`)) return;

        try {
            const response = await fetch(`/api/book/${bookId}/comment/${commentId}`, {
                method: 'DELETE'
            });
            if (!response.ok) throw new Error("Ошибка удаления комментария");

            setComments(state.comments.filter(c => c.id != commentId));
        } catch (err) {
            alert(err.message);
            console.error(err);
        }
    }

    function goToAddComment() {
        window.location.href = `/book/${bookId}/comment/new`;
    }

    document.addEventListener("DOMContentLoaded", loadComments);
</script>

</body>
</html>
