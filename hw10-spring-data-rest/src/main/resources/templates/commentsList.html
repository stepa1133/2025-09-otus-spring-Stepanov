<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>List of all comments</title>

    <style type="text/css">
        body {
            padding: 50px;
        }
        .comments {
            border: 1px solid steelblue;
            width: 300px;
            border-collapse: collapse;
        }

        .comments tr td,
        .comments th {
            padding: 5px;
            border: 1px solid steelblue;
        }

        .comments td:first-child,
        .comments td:last-child {
            width: 50px;
            text-align: center;
        }

        button {
            cursor: pointer;
        }
    </style>

    <style type="text/css" th:inline="text">
        h3 {
            background-image: url([[@{/listmark.png}]]);
            background-repeat: no-repeat;
            padding: 2px;
            padding-left: 30px;
        }
    </style>
</head>

<body>

<h3 th:text="#{comments-table-header}">Comments:</h3>

<table class="comments">
    <thead>
    <tr>
        <th th:text="#{book-field-id}">ID</th>
        <th th:text="#{comment-field-name}">Comment</th>
        <th th:text="#{books-table-column-action}">Action</th>
    </tr>
    </thead>

    <tbody>
    <tr th:each="comment : ${comments}">
        <td th:text="${comment.id}">1</td>
        <td th:text="${comment.commentary}">Kek</td>
        <td>
            <button type="button"
                    th:attr="data-comment-id=${comment.id}"
                    th:attrappend=" data-book-id=${bookId}"
                    onclick="deleteComment(this)">
                Удалить
            </button>
        </td>
    </tr>
    </tbody>

    <tfoot>
    <tr>
        <td colspan="2" style="text-align: center; font-style: italic;">
            Всего комментариев: <span th:text="${comments.size()}">0</span>
        </td>
        <td>
            <form th:action="@{/book/{id}/comment/new(id=${bookId})}" method="get" class="action-form">
                <button type="submit" class="action-btn add-btn" th:text="#{add-new-commentary-button}">
                    Add
                </button>
            </form>
            <form th:action="@{/book}" method="get" class="action-form" style="display: inline-block;">
                <button type="submit" class="action-btn">
                    На главную
                </button>
            </form>
        </td>
    </tr>
    </tfoot>
</table>

<script>
    function deleteComment(button) {
        const commentId = button.getAttribute('data-comment-id');
        const bookId = button.getAttribute('data-book-id');
        const commentText = button.closest('tr').querySelector('td:nth-child(2)').innerText;

        if (!confirm('Точно удалять комментарий "' + commentText + '"?')) return;

        fetch(`/book/${bookId}/comment/${commentId}`, {
            method: 'DELETE'
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка при удалении комментария');
                }
                window.location.reload();
            })
            .catch(error => {
                alert(error.message);
            });
    }
</script>

</body>
</html>
